name: CI

on:
  pull_request:
  push:
    branches:
      - main

env:
  GO_VERSION: 1.25.x
  GOLANGCI_LINT_VERSION: v2.6

jobs:
  vet:
    name: go vet
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: go vet
        run: go vet ./...

  lint:
    name: golangci-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m

  run-examples:
    name: Run all examples
    runs-on: ubuntu-latest
    needs: [vet, lint]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: List examples
        run: go run ./cmd/gopatterns -list

      - name: Execute each example with timeout
        shell: bash
        run: |
          set -euo pipefail
          # Extract example keys from the -list output. Lines look like:
          #  " - <key>: <doc>"
          examples=$(go run ./cmd/gopatterns -list | sed -n 's/^ - \([^:]*\).*/\1/p')

          echo "Found examples:"
          echo "$examples" | sed 's/^/  - /'

          for ex in $examples; do
            echo ""
            echo ">>> Running $ex"
            # 25s per example so none hang forever
            timeout 25s go run ./cmd/gopatterns -example=$ex
            echo "<<< OK: $ex"
          done
